#!/usr/bin/env bash

if [ -z "$1" ]; then
  echo "Usage: copy <filename>"
  exit 1
fi

if [ ! -f "$1" ]; then
  echo "Error: File '$1' not found."
  exit 1
fi

if [ -n "$DEVSHELL_PROJECT_ID" ]; then
    METHOD="OSC 52 (Cloud Shell)"
    COPY_CMD="osc52"
elif command -v pbcopy &> /dev/null; then
    METHOD="pbcopy (macOS)"
    COPY_CMD="pbcopy"
elif command -v xclip &> /dev/null; then
    METHOD="xclip (Linux/X11)"
    COPY_CMD="xclip -selection clipboard"
elif command -v xsel &> /dev/null; then
    METHOD="xsel (Linux/X11)"
    COPY_CMD="xsel --clipboard --input"
elif command -v wl-copy &> /dev/null; then
    METHOD="wl-copy (Wayland)"
    COPY_CMD="wl-copy"
elif command -v termux-clipboard-set &> /dev/null; then
    METHOD="termux-api (Android)"
    COPY_CMD="termux-clipboard-set"
elif command -v clip.exe &> /dev/null; then
    METHOD="clip.exe (WSL/Windows)"
    COPY_CMD="clip.exe"
else
    METHOD="OSC 52 (Generic Headless)"
    COPY_CMD="osc52"
fi

if [ "$COPY_CMD" == "osc52" ]; then
    PAYLOAD=$(base64 < "$1" | tr -d '[:space:]')
    printf "\033]52;c;%s\a" "$PAYLOAD"
    echo "✅ Success: Contents of '$1' sent to local clipboard via $METHOD."
else
    cat "$1" | $COPY_CMD
    echo "✅ Success: Contents of '$1' copied via $METHOD."
fi
